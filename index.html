<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE Talk Analytics - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #06c755;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --sidebar-width: 280px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        /* Layout Structure */
        #app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* Sidebar (File Input & Branding) */
        aside {
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.4s ease-in-out;
        }
        aside.loaded {
            transform: translateY(-100%);
        }

        /* Main Dashboard */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.5s ease 0.4s;
        }
        main.visible { opacity: 1; }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: auto 1fr;
            height: 100%;
            gap: 0;
        }

        /* Member List Panel */
        .member-panel {
            grid-row: 1 / -1;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .member-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            font-weight: bold;
            color: #555;
        }
        .member-list {
            overflow-y: auto;
            flex: 1;
        }
        .member-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f9f9f9;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .member-item:hover { background-color: #f8f9fa; }
        .member-item.active {
            background-color: #e8f5e9;
            border-left: 4px solid var(--primary-color);
        }
        .member-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
        .member-count { font-size: 0.8rem; color: #888; background: #eee; padding: 2px 8px; border-radius: 10px; }

        /* Content Area */
        .content-area {
            padding: 20px;
            overflow-y: auto;
            background: var(--bg-color);
        }

        /* Cards */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            margin-bottom: 20px;
            height: 100%;
        }
        .card-title-sm {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            margin-bottom: 10px;
            font-weight: 700;
        }

        /* Detail Grid */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .user-hero {
            grid-column: span 3;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .avatar-placeholder {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, #06c755, #2ecc71);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: bold;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { overflow: auto; }
            #app-container { height: auto; overflow: visible; display: block; }
            aside.loaded { display: none; } /* Hide logic simpler for mobile */
            main { height: auto; overflow: visible; opacity: 1; display: none; }
            main.visible { display: block; }

            .dashboard-grid {
                display: flex;
                flex-direction: column;
                height: auto;
            }
            .member-panel {
                height: 300px; /* Fixed height for list on mobile */
                order: 2;
            }
            .content-area {
                order: 1;
                padding: 15px;
                height: auto;
            }
            .detail-grid { grid-template-columns: 1fr; }
            .user-hero { grid-column: span 1; }
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            max-width: 500px;
            width: 90%;
        }
        .drop-zone:hover { border-color: var(--primary-color); background: rgba(6,199,85,0.05); }

        /* Loading */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9);
            z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-success mb-3" role="status"></div>
        <div class="fw-bold">解析中...</div>
    </div>

    <div id="app-container">
        <aside id="uploadScreen">
            <div class="mb-4">
                <i class="bi bi-chat-dots-fill text-success" style="font-size: 4rem;"></i>
            </div>
            <h2 class="fw-bold mb-2">LINE Analysis Dashboard</h2>
            <p class="text-muted mb-5">統計解析・多人数対応版</p>

            <div class="drop-zone shadow-sm" id="dropZone">
                <i class="bi bi-file-earmark-text display-4 mb-3 d-block text-secondary"></i>
                <h5 class="fw-bold">トーク履歴(.txt)を選択</h5>
                <p class="small text-muted mb-0">またはここにドラッグ＆ドロップ</p>
                <input type="file" id="fileInput" accept=".txt" hidden>
            </div>
            <p id="errorMsg" class="text-danger mt-3 small fw-bold"></p>
            <div class="mt-4 small text-muted">
                <i class="bi bi-lock-fill"></i> データは端末内でのみ処理されます
            </div>
        </aside>

        <main id="mainDashboard">
            <div class="dashboard-grid">
                
                <div class="member-panel shadow-sm">
                    <div class="member-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-people-fill me-2"></i>メンバー</span>
                        <span class="badge bg-secondary" id="totalMembers">0</span>
                    </div>
                    <div class="member-list" id="memberList">
                        </div>
                </div>

                <div class="content-area">
                    
                    <div class="row mb-4">
                        <div class="col-6 col-md-3">
                            <div class="stat-card p-3 text-center">
                                <div class="card-title-sm">総メッセージ</div>
                                <div class="h3 fw-bold mb-0" id="valTotalMsg">-</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-card p-3 text-center">
                                <div class="card-title-sm">期間 (日)</div>
                                <div class="h3 fw-bold mb-0" id="valPeriod">-</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-card p-3 text-center">
                                <div class="card-title-sm">スタンプ率</div>
                                <div class="h3 fw-bold text-warning mb-0" id="valStickerRate">-</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-card p-3 text-center">
                                <div class="card-title-sm">1日平均</div>
                                <div class="h3 fw-bold text-success mb-0" id="valDailyAvg">-</div>
                            </div>
                        </div>
                    </div>

                    <div id="userDetailArea" class="mb-4">
                        <div class="user-hero">
                            <div class="avatar-placeholder" id="userAvatar">U</div>
                            <div>
                                <h3 class="fw-bold mb-0" id="userName">Select User</h3>
                                <div class="text-muted small" id="userRank">ランキング -位</div>
                            </div>
                        </div>

                        <div class="detail-grid">
                            <div class="stat-card" style="grid-column: span 1; min-height: 300px;">
                                <div class="card-title-sm">ユーザー特性</div>
                                <div style="height: 250px; position: relative;">
                                    <canvas id="radarChart"></canvas>
                                </div>
                            </div>

                            <div class="stat-card" style="grid-column: span 2;">
                                <div class="card-title-sm">アクティビティ詳細</div>
                                <div class="row g-4 mt-1">
                                    <div class="col-6 col-md-4">
                                        <div class="small text-muted">送信数</div>
                                        <div class="fs-4 fw-bold" id="uMsgCount">-</div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="small text-muted">スタンプ使用</div>
                                        <div class="fs-4 fw-bold" id="uStickerCount">-</div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="small text-muted">平均返信(分)</div>
                                        <div class="fs-4 fw-bold" id="uReplyAvg">-</div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="small text-muted">夜型度 (23-4時)</div>
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar bg-dark" id="barNight" style="width: 0%"></div>
                                        </div>
                                        <div class="small fw-bold mt-1" id="valNight">-</div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="small text-muted">会話開始回数</div>
                                        <div class="fs-4 fw-bold text-primary" id="uInit">-</div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="small text-muted">感謝 / 謝罪</div>
                                        <div class="small fw-bold text-primary">Thanks: <span id="uThanks">-</span></div>
                                        <div class="small fw-bold text-secondary">Sorry: <span id="uSorry">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="card-title-sm">全体メッセージ推移</div>
                        <div style="height: 250px; width: 100%;">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        // CONFIG
        const CONFIG = {
            ignoreNames: ['保存日時', 'System', 'システム', '', 'トーク履歴'],
            ignorePatterns: [/が退出しました/, /通話をキャンセル/, /グループに参加/, /アルバムを作成/, /ノートを作成/, /通話時間/, /音声通話/],
            keywords: {
                gratitude: ['ありがとう', 'あざ', 'サンキュー', '感謝', 'thanks'],
                apology: ['ごめん', 'すまん', '申し訳', '謝', 'sorry']
            }
        };

        let charts = {};
        let globalStats = null;

        // DOM Elements
        const els = {
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            uploadScreen: document.getElementById('uploadScreen'),
            mainDashboard: document.getElementById('mainDashboard'),
            loading: document.getElementById('loading-overlay'),
            errorMsg: document.getElementById('errorMsg'),
            memberList: document.getElementById('memberList')
        };

        // Event Listeners
        els.dropZone.addEventListener('click', () => els.fileInput.click());
        els.dropZone.addEventListener('dragover', e => { e.preventDefault(); els.dropZone.style.borderColor = '#06c755'; });
        els.dropZone.addEventListener('dragleave', () => els.dropZone.style.borderColor = '#ccc');
        els.dropZone.addEventListener('drop', e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });
        els.fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

        function handleFile(file) {
            if(!file || !file.name.endsWith('.txt')) {
                els.errorMsg.textContent = "テキストファイル(.txt)のみ対応しています";
                return;
            }
            els.loading.style.display = 'flex';
            const reader = new FileReader();
            reader.onload = e => {
                setTimeout(() => {
                    try {
                        const parsed = parseText(e.target.result);
                        if(parsed.length === 0) throw new Error("有効なメッセージが見つかりません");
                        globalStats = analyze(parsed);
                        renderDashboard(globalStats);
                        
                        // Transition
                        els.uploadScreen.classList.add('loaded');
                        els.mainDashboard.classList.add('visible');
                    } catch(err) {
                        els.errorMsg.textContent = "解析エラー: " + err.message;
                        console.error(err);
                        els.uploadScreen.classList.remove('loaded');
                    } finally {
                        els.loading.style.display = 'none';
                    }
                }, 100);
            };
            reader.readAsText(file);
        }

        // --- Parsing Logic ---
        function parseText(text) {
            const lines = text.split(/\r?\n/);
            const data = [];
            let date = null;
            const datePtn = /^(\d{4})[\/\.](\d{1,2})[\/\.](\d{1,2})/; // 2023/01/01 or 2023.01.01
            const timePtn = /^\d{1,2}:\d{2}$/;

            lines.forEach(line => {
                line = line.trim();
                if(!line) return;
                
                const dMatch = line.match(datePtn);
                if(dMatch) {
                    date = `${dMatch[1]}/${dMatch[2].padStart(2,'0')}/${dMatch[3].padStart(2,'0')}`;
                    return;
                }

                if(date) {
                    const parts = line.split('\t'); // LINE export is tab-separated
                    if(parts.length >= 3 && timePtn.test(parts[0])) {
                        const sender = parts[1].trim();
                        if(CONFIG.ignoreNames.includes(sender)) return;
                        if(CONFIG.ignorePatterns.some(p => p.test(sender))) return;

                        let content = parts.slice(2).join('\t');
                        if(content.startsWith('"') && content.endsWith('"')) content = content.slice(1, -1);
                        
                        let type = 'text';
                        if(content.includes('[スタンプ]') || content.includes('[Sticker]')) type = 'sticker';
                        else if(['[写真]','[動画]'].some(k=>content.includes(k))) type = 'media';

                        const [hh, mm] = parts[0].split(':').map(Number);
                        data.push({
                            date, timestamp: new Date(`${date} ${parts[0]}`),
                            hour: hh, sender, content, type
                        });
                    }
                }
            });
            return data;
        }

        // --- Analysis Logic (No Word Cloud) ---
        function analyze(data) {
            const users = {};
            const daily = {};
            let totalSticker = 0;
            let lastMsg = null;

            data.forEach(d => {
                // User Stats Init
                if(!users[d.sender]) {
                    users[d.sender] = { 
                        count: 0, sticker: 0, chars: 0,
                        replyTimes: [], initiation: 0,
                        hourly: Array(24).fill(0),
                        thanks: 0, sorry: 0
                    };
                }
                const u = users[d.sender];
                u.count++;
                u.hourly[d.hour]++;

                if(d.type === 'sticker') {
                    u.sticker++;
                    totalSticker++;
                } else if(d.type === 'text') {
                    u.chars += d.content.length;
                    if(CONFIG.keywords.gratitude.some(k=>d.content.includes(k))) u.thanks++;
                    if(CONFIG.keywords.apology.some(k=>d.content.includes(k))) u.sorry++;
                }

                // Daily Stats
                daily[d.date] = (daily[d.date] || 0) + 1;

                // Reply & Initiation Analysis
                if(lastMsg && lastMsg.sender !== d.sender) {
                    const diffMin = (d.timestamp - lastMsg.timestamp) / (1000 * 60);
                    if(diffMin < 720) u.replyTimes.push(diffMin); // Reply within 12h
                    if(diffMin > 360) u.initiation++; // Gap > 6h means initiation
                } else if(!lastMsg) {
                    u.initiation++;
                }
                lastMsg = d;
            });

            // Post-Process Users
            const userList = Object.keys(users).sort((a,b) => users[b].count - users[a].count);
            userList.forEach(name => {
                const u = users[name];
                const sumReply = u.replyTimes.reduce((a,b)=>a+b,0);
                u.avgReply = u.replyTimes.length ? (sumReply / u.replyTimes.length) : 0;
                
                const nightCount = u.hourly.slice(23).concat(u.hourly.slice(0,5)).reduce((a,b)=>a+b,0); // 23:00 - 04:59
                u.nightRate = u.count ? (nightCount / u.count) : 0;
                u.avgLen = (u.count - u.sticker) > 0 ? (u.chars / (u.count - u.sticker)) : 0;
                u.stickerRate = u.count ? (u.sticker / u.count) : 0;
            });

            return {
                users, userList, daily,
                total: data.length, totalSticker,
                start: data[0].date, end: data[data.length-1].date
            };
        }

        // --- Rendering ---
        function renderDashboard(data) {
            // 1. Global Stats
            const startD = new Date(data.start);
            const endD = new Date(data.end);
            const days = Math.max(1, Math.ceil((endD - startD)/(86400000)) + 1);

            document.getElementById('valTotalMsg').innerText = data.total.toLocaleString();
            document.getElementById('valPeriod').innerText = days;
            document.getElementById('valStickerRate').innerText = ((data.totalSticker/data.total)*100).toFixed(1) + "%";
            document.getElementById('valDailyAvg').innerText = (data.total / days).toFixed(1);
            document.getElementById('totalMembers').innerText = data.userList.length;

            // 2. Member List
            const listEl = document.getElementById('memberList');
            listEl.innerHTML = '';
            data.userList.forEach((name, idx) => {
                const u = data.users[name];
                const item = document.createElement('div');
                item.className = 'member-item';
                if(idx === 0) item.classList.add('active');
                item.onclick = () => selectUser(name, idx, item);
                item.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center me-2" style="width:30px; height:30px; font-size:0.8rem;">${name[0]}</div>
                        <div class="member-name">${name}</div>
                    </div>
                    <div class="member-count">${u.count}</div>
                `;
                listEl.appendChild(item);
            });

            // 3. Initial Chart Render (Global Line)
            renderLineChart(data.daily);

            // 4. Select Top User
            if(data.userList.length > 0) {
                updateUserDetail(data.userList[0], 0);
            }
        }

        function selectUser(name, idx, el) {
            document.querySelectorAll('.member-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            updateUserDetail(name, idx);
        }

        function updateUserDetail(name, rank) {
            const u = globalStats.users[name];
            
            // Text Updates
            document.getElementById('userName').innerText = name;
            document.getElementById('userAvatar').innerText = name[0];
            document.getElementById('userRank').innerText = `メッセージ数順位: ${rank + 1}位`;
            
            document.getElementById('uMsgCount').innerText = u.count.toLocaleString();
            document.getElementById('uStickerCount').innerText = `${u.sticker} (${(u.stickerRate*100).toFixed(1)}%)`;
            document.getElementById('uReplyAvg').innerText = u.avgReply.toFixed(1);
            document.getElementById('uInit').innerText = u.initiation;
            document.getElementById('uThanks').innerText = u.thanks;
            document.getElementById('uSorry').innerText = u.sorry;
            
            // Night Bar
            const nightPct = (u.nightRate * 100).toFixed(1);
            document.getElementById('barNight').style.width = Math.min(100, nightPct * 2) + "%"; // Scale up visual
            document.getElementById('valNight').innerText = `${nightPct}%`;

            // Radar Chart Update
            renderRadar(u);
        }

        function renderRadar(u) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if(charts.radar) charts.radar.destroy();

            // Normalize Metrics (0-100)
            // Reply: Faster is better (Lower is higher score). Max assumed 60min avg.
            const scoreSpeed = Math.max(0, 100 - (u.avgReply / 60 * 100));
            // Night: 0% is day (0), 50% is owl (100).
            const scoreOwl = Math.min(100, (u.nightRate / 0.5) * 100);
            // Long: Avg len 30 chars = 100.
            const scoreLong = Math.min(100, (u.avgLen / 30) * 100);
            // Sticker: 50% sticker = 100.
            const scoreSticker = Math.min(100, (u.stickerRate / 0.5) * 100);
            // Active: Initiation count. Normalized against max initiation in group would be better, but fixed for now.
            const scoreActive = Math.min(100, u.initiation * 2); 

            charts.radar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['返信速度', '夜型度', '長文度', 'スタンプ', '積極性'],
                    datasets: [{
                        label: '特性スコア',
                        data: [scoreSpeed, scoreOwl, scoreLong, scoreSticker, scoreActive],
                        backgroundColor: 'rgba(6, 199, 85, 0.2)',
                        borderColor: '#06c755',
                        pointBackgroundColor: '#06c755'
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0, max: 100,
                            ticks: { display: false },
                            pointLabels: { font: { size: 12 } }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderLineChart(dailyData) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            const labels = Object.keys(dailyData).sort();
            const values = labels.map(d => dailyData[d]);

            if(charts.line) charts.line.destroy();

            charts.line = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'メッセージ数',
                        data: values,
                        borderColor: '#06c755',
                        backgroundColor: 'rgba(6, 199, 85, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        borderWidth: 1.5
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { beginAtZero: true, grid: { borderDash: [5, 5] } }
                    },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }
    </script>
</body>
</html>
